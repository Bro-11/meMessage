<!DOCTYPE html>
<title>meMessage</title>
<link rel="icon" href="data:image/octet-stream;base64,UklGRtgEAABXRUJQVlA4IMwEAACwHwCdASqpALQAPp1KnUwlq6mtJtZJeaATiWNuvTSdUqQKVYvPYyCA4u7eKddA98GLdhjQSguCD7yRjNX2KDTVjc9GxXG7qwDWW1UMUuL7jyq1PyMkMVzJ3ogJPtb7q+3pBdoldw1i2+wRIOn/4SZGHIZovmesPBgg8tkxcQ2sw2tjDozX8bQpP9i/jT87QZq31UDpj6nCggyoU4dkScILrbgaToZvtkm9XUdESScMw+rOgYNO6v1w9Uh9vTyGpmwLbCKYEfbbqn8jdYcUpXYCxHZ/n3A/VVInu3Yo5KpDU5Rzj2AvmRIAF4C////Wm1DU87JZvo9VASEqqvXPRJTff9JEfMJgAP2sdsy//5MJ/ba/xTwd//kGP2NfkpyNGY4k1heb0GATWExoxcvfYVrnH8gUil5u2i3eRkMxgDahMQgO93JsP6dipP9RWr8FXOMdjdmgd/ivjpkSYDO0mIeARfF2YKVwZXaMyL+7OTFJCyxtTjc7l/WIkhnKhFUDgxm00k6RDPYwzr2T68MS1Q3bUo436pjOA9lYADs94to9jrVM7DU+udJPHLjocCnMYpEI+cSpb+tMX4ZIIt4ZLgBMUS+DSLnHq7LBTPsaTF2RUOgwsuoaayMY40Obs3zM27xW6fZyaUuBcNbtGrbHs4aXGeLz7u8CT8gZLjY0Qr1vNghcyW+o0nvfAp+PU/KF0hReoFnWh5BR8GQh9bPIftrlYwaKJZLsSwhz2lOfDkKUbJsbIxvH34+so3l8afJb7GeK+uzSRcW2qWNQzK7NXGh+gdaCaDN9ATVT61ROODozypanYOZb4fQXk6E9dW/wUYWdXgtGbeqA1oow1FUJJ3JO5yHj3gsLugnBNGwzyvgYJc8vNOPNrqhH79EHtuxLRxBJQyu912CjcwjRUHhRBjT+2r2nojlJEgIelNxE1/kZFUJy0jw40rTnsuPeYSWYaLdp0dWpeFaqemQnNiyjl+PgDHD5GFby3uw0NQ88tYYK94RxKC7g15Qt45CPEgCrRxOGw5w0DkO3ufrUPQF49uG+TwWCjz1+i02INrT8hKoLTjbkVrFO+fEJcaSyelZPOe1nDmuQbAomIwsxdT7ArTp9uzIlh6CVsig/E362n+0TGlk3WvNuTox7mZkKI6ErujxEFZAFmCgr7U/OxsfaOd5KIaJ18Nd9QeZ8+PfQRu/rVP9lCXmgVTDgV1Y2wliRhvvl/oeBH/DrIg03Axpv3TigKjyAX3kF2pdp+AqSzz0AWeUshSe4DkhU/4ATEgHbhApoYNvwrTezI5dWLkOEeLCSJvTHcg0RWQXMnJIwkvdjTdv+hD2+bnEh4JGMiFUInUEOK9HtDiAbypwoy+psRpwzjEKxd5LLW1U+Q5X5EJr7rsuvdZDtrVE49wZCn0K+QdqS6cxeeWfWZO3atIBaXwjIr0FUAnt6rBsFri9FbQ/3PJd3a0go8WybsrzUclIeGcqj8M1EPhFX93GL9PZcRSYithgmj4oeIt7L45p629dIiQ3AxjZXt3yl8rX2CjqEcXbAELgwt2pI/d+5zX1dHCyG903OzXTk9HHurTRnw1Jpk0j9evm3xDGifMQIt0cODt2LS+mm4R6uGxE/oaSkaHt0MRO1pBbtjjLMAAAA">
<div style="text-align: center;">
    <h1 id="title">
      Loading...
    </h1>
  </div>
  <div id="messages"></div>
  <div id="chats">
    
  </div>
  <input id="type" type="text" placeholder="new meMessage..." maxlength="200"/>
  <button id="sendBtn" onclick="send()"><img src="https://cdn-icons-png.flaticon.com/512/25/25637.png" width="17px" height="17px" style="filter: invert(100%) brightness(50%)" alt="Send"></button>
  <button id="nameBtn" onclick="changeName()">Change Chat Name</button><script>var url = `https://retoolapi.dev/09OX6R/messages/5`;
var max=0;
if (!localStorage.meMsgUser || localStorage.meMsgUser=="null") {
  localStorage.meMsgUser=prompt("Enter your first name...  (This is your display username, you cannot change it once it is set!)");
}
var username = localStorage.meMsgUser;
var passes;

var chatDiv = document.querySelector("#chats")
setTimeout(e=>{for (var i = 1;i <= 149;i++) {
let enterChatBtn = document.createElement("button");
enterChatBtn.setAttribute("number",i)
enterChatBtn.onclick=e=>{
  promptEntering(e.target.getAttribute("number"))
}
enterChatBtn.classList.add("chatbtn");
enterChatBtn.innerText = passes.names.toString().split(",")[i-1];

chatDiv.appendChild(enterChatBtn);
}},1300)


var msg = { messages: {} }
var O = {}
async function api(changeType="get", change={}) {
if (changeType == "put") {
  await fetch(url, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(change)
    })
  .then(response => response.json())
  .then(data => o = data)
} else if (changeType == "get") {
  await fetch(url,{method:"GET"}).then(r=>r.json()).then(d=>o=d)
  O=o

}
if (changeType == "add") {
  O = addMessage(change)
  api("put",O)
  window.scrollTo({ 
  top: document.body.scrollHeight, 
  behavior: "smooth" 
  })
}
msg = o
}

// CHAT, Tudor, AJB, Coker

async function updatePasses() {
await fetch("https://retoolapi.dev/09OX6R/messages/150",{method:"GET"}).then(r=>r.json()).then(d=>passes=d)
passes=passes
}


function promptEntering(num) {
//localStorage["enteredChat"+num]="yes"
if (localStorage["enteredChat"+num]!=="yes") {
let pasio = passes.passwords.toString().split(",")[num-1];
let pass;
if (!pasio=="") {pass = btoa(prompt("Enter password..."));} else {pass=""}
if (pasio==pass) {
  url="https://retoolapi.dev/09OX6R/messages/"+num;
  localStorage["enteredChat"+num]="yes"
}
console.log(passes[num-1], num-1)
console.log(pass)
} else {
  url="https://retoolapi.dev/09OX6R/messages/"+num;
}
}

function addMessage(newMessage, targetObject = msg) {
    // === FIX STARTS HERE: Use targetObject or default to a safe structure ===
    if (typeof targetObject !== 'object' || targetObject === null || !targetObject.messages) {
        // If the expected targetObject is invalid, log an error and return an empty, valid structure
        console.error("Target object for adding message is invalid, returning default structure.");
        targetObject = { messages: {} };
    }
    // === FIX ENDS HERE ===
    
    const messages = targetObject.messages;
    const existingKeys = Object.keys(messages); // <-- Now safe!
    
    let maxIndex = 0;
    for (const key of existingKeys) {
        const index = parseInt(key.substring(1));
        if (index > maxIndex) {
            maxIndex = index;
        }
    }
    const newKey = `m${maxIndex + 1}`;
    
    // Ensure 'messages' itself is a valid object before spreading
    const currentMessages = typeof targetObject.messages === 'object' && targetObject.messages !== null 
        ? targetObject.messages 
        : {};

    const newMessages = { 
        ...currentMessages, 
        [newKey]: newMessage  
    };
    
    return {  
        ...targetObject,  
        messages: newMessages  
    };
}

const updatedMessages = {
messages: {
  m1: {
    sender: {
      user: "Server",
      time: "0:00 AM"
    },
    message: "Chat reset by server admin"
  }
}
};

async function reset() {
  let resetStr = "Chat reset "
  let resetStrings = [
    "by Google Gemini",
    "by ChatGPT",
    "because the devs broke smth",
    "because geese broke into your house",
    "becuase the APs found you",
    "because your computer got isolated for going on furry dating websites",
    "by the Hollow Knight",
    "by Hornet",
    "by Jeffrey Epstein",
    "because Nintendo's suing us twin ü•Ä",
    "by a flock of ferocious furry femboys",
    "because a wild NullReferenceException appeared",
    "because your CPU ran out of elixir",
    "because nobody would join Jarred in Kart Bros",
    "by \"Uncaught TypeError: Cannot read properties of undefined (reading 'reset')\"",
    "by sneaky golem in the pocket",
    "by Clippy",
    "by evo skelly nike pro",
    "bc ur chopped twin ü•Äüò≠üò≠üôè"
  ]
  resetStr += resetStrings[Math.floor(Math.random()*resetStrings.length)]
  updatedMessages.messages.m1.message=resetStr;
  await api("put",updatedMessages)
}

async function resetAll() {
  for (var i = 123;i < 150;i++) {
    url = "https://retoolapi.dev/09OX6R/messages/"+i
    await reset()
  }
}

function getTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0'); 
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12; 
    return `${displayHours}:${minutes} ${ampm}`;
}

function send() {
if (document.querySelector("input").value.trim()=="") {} else {
  api("add",{sender: {user: [username], time: [getTime()]},message: [document.querySelector("input").value]});
  document.querySelector("input").value=""
  setTimeout(() => { window.scrollTo({
      top: document.body.scrollHeight,
      behavior: "smooth"
  });
}, 1100)
}
}

document.onkeypress=e=>{if (e.key=="Enter") {send()}}
var m;
fetch("https://retoolapi.dev/09OX6R/messages/1",{method:"GET"}).then(r=>r.json()).then(d=>m=d.messages)

fetch(url).then(r=>r.json()).then(d=>max=Object.keys(d.messages).length);


async function changeName() {
let num = Number(url.split("messages/")[1]);
let newName = prompt("Enter new chat name...  (Max length 16 characters, click cancel or press escape to return)");
if (newName==null||newName=="") {} else {
  newName = newName.substring(0,16)
  console.log(newName)

let newPasses = passes.names.toString().split(",");
newPasses[num-1]=newName
console.log(newPasses)
let new150 = {
  names: [newPasses],
  passwords: [passes.passwords]
}
console.log(new150)
let preUrl=url;
url="https://retoolapi.dev/09OX6R/messages/150";
await api("put",new150);
url=preUrl;
location.reload()
}
}


function edit(messageIndex, editType, editData) {
  let messageToEdit = msg.messages["m"+messageIndex];
  if (editType == "all") {
    messageToEdit = editData;
  }
  if (editType == "message") {
    messageToEdit.message = editData;
  }
  if (editType == "time") {
    messageToEdit.sender.time = editData;
  }
  if (editType == "user") {
    messageToEdit.sender.user = editData;
  }
  if (editType == "reactions") {
    messageToEdit.reactions = editData;
  }
  msg.messages["m"+messageIndex] = messageToEdit;
  api("put",msg);
}


function updateTexts() {
    if (!msg || !msg.messages) {
        // If the data hasn't loaded yet, just exit the function.
        return;
    }
    let scrollWhy = window.scrollY;
    
let chatNum = parseInt(url.split("messages/")[1]);
let chatDiv = document.getElementById("chats");
document.querySelector("h1").innerText = chatDiv.querySelectorAll("button")[chatNum-1].innerText;

document.querySelector("#messages").innerHTML="";
for (var i = 0;i < Object.keys(msg.messages).length;i++) {
  let bubble = document.createElement("div");
  bubble.____MID=i+1
  let sender = msg.messages["m"+(i+1)]
  bubble.style = `
    position: absolute;
    top: ${70*i+100}px;
    ${sender.sender.user==username?("right: 50px;"):"left: 130px;"}
    background: ${sender.sender.user==username?("#1584ff"):"#262529"};
    color: white;
    height: 40px;
    border: 1px solid black;
    display: inline-block;
    min-width: 35px;
    max-width: 75%;
    overflow-wrap: break-word;
    cursor: default;
  `
  bubble.oncontextmenu = _thisBubble => {
    try{
      sender = msg.messages["m"+_thisBubble.target.____MID].sender;}
    catch{
      //Trying to get the message id even though the user clicked on a reaction
      return;}
    _thisBubble.preventDefault();
    var reactUi = document.createElement("div");
    reactUi.style = `
      position: fixed;
      bottom: 20px;
      height: 40px;
      left: 140px;
      width: calc(100% - 225px);
      border-radius: 12px;
      background: #262529;
      border: 1px solid #7c7c7c;
      color: white;
      z-index: 10001;
      padding-left: 8px;
      
    `
    document.body.appendChild(reactUi);
    let blackness = document.createElement("div");
    blackness.addEventListener("click", () => {
      document.body.removeChild(reactUi)
    });
    blackness.style=`
    position: absolute;
    left: -10000px;
    top: -10000px;
    width: 30000px;
    height: 30000px;
    background: #0008;
    z-index: -100;
    `
    reactUi.appendChild(blackness)

    // begin edit
    if (msg.messages["m"+_thisBubble.target.____MID].sender.user==username) {
      let editBtn = document.createElement("button");
      editBtn.onclick = e => {
        let newMsg = prompt("Enter edited message", msg.messages["m"+_thisBubble.target.____MID].message)
        if (newMsg == null || newMsg.trim() == "") {} else {
          edit(_thisBubble.target.____MID,"message",newMsg);
          document.body.removeChild(reactUi);
        }
      }
      editBtn.classList.add("editBtn")
      editBtn.innerText = "Edit Message";
      reactUi.appendChild(editBtn)
    }
    // end edit

    let defaultReactions = ["‚ù§Ô∏è", "üòÇ", "üëç", "üëé", "‚ùï", "‚ùî","üêê","üòÆ","üò°","üòù","ü§ë","ü§î","üò≠","ü•Ä","üíÄ","‚òπÔ∏è","üî•","üéâ","üôè","üñï","ü´¶","ü•∑","üëØ‚Äç‚ôÄÔ∏è","ü§π‚Äç‚ôÇÔ∏è","üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®","ü¶≤","üçÜ","üçí","üßä","üïã","üåà","‚ö°","‚õÑ","üß¢","üìé"];

const currentUsername = username;

const targetMessageId = "m" + _thisBubble.target.____MID;
const targetMessageObject = msg.messages[targetMessageId];

const userExistingReaction = targetMessageObject.reactions 
    ? targetMessageObject.reactions[currentUsername] 
    : undefined;

for (const emoji of defaultReactions) {
    let btn = document.createElement("button");
    btn.innerText = emoji;
    btn.classList.add("reactBtn");

    if (userExistingReaction === emoji) {
        btn.classList.add("reactSelected"); 
    }

    btn.onclick = (_thisButton) => {
        const messageObject = targetMessageObject; 

        if (!messageObject.reactions) {
            messageObject.reactions = {};
        }

        const currentReaction = messageObject.reactions[currentUsername];
        
        if (currentReaction === emoji) {
            delete messageObject.reactions[currentUsername];
        } else {
            messageObject.reactions[currentUsername] = emoji; 
        }

        edit(_thisBubble.target.____MID, "reactions", messageObject.reactions);
        document.body.removeChild(reactUi);
    };

    reactUi.appendChild(btn);
    document.onkeydown=e=>e.key=="Escape"?document.body.removeChild(reactUi):0;
}
  }
  bubble.innerText = sender.message
  document.querySelector("#messages").appendChild(bubble)
  if (!sender.sender.user.includes(username)) {
    var nameplate = document.createElement("span");
    nameplate.innerText = sender.sender.user + ", " + sender.sender.time;
    nameplate.style = `
      position: absolute;
      font-size: 9px;
      top: -10px;
      left: 5px;
      white-space: nowrap;
      z-index: 9000000000000000;
    `
    bubble.appendChild(nameplate);
  }

  if (!!sender.reactions && Object.keys(sender.reactions).length > 0) {
      let reactionsHTML = "";
      for (var j in msg.messages["m"+(i+1)].reactions) {
        if (j==username) reactionsHTML+=" <span class='myReact'>"+msg.messages["m"+(i+1)].reactions[j]+"</span>"
        else reactionsHTML+=" "+msg.messages["m"+(i+1)].reactions[j]
      }

      var reaction = document.createElement("span");
      reaction.innerHTML = reactionsHTML; 
      reaction.style = `
      position: absolute;
      ${sender.sender.user==username?("right"):"left"}: ${bubble.offsetWidth-7.5}px; 
      white-space: nowrap;
      top: -10px;
      background: #262529;
      border-radius: 9px;
      border: 1px solid white;
      padding: 1px 4px; /* Added padding for better appearance */
      `;
      bubble.appendChild(reaction);
  }

}
let b = document.createElement("div");
b.style = `
    position: absolute;
    top: ${70*(Object.keys(msg.messages).length)+100}px;
    width: 70%;
    height: 40px;
    border: none;
  `
document.querySelector("#messages").appendChild(b)

window.scrollTo({top: scrollWhy})
}

/*let names = ["OG GC","Jacob+Tudor","AJB","Coker","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed","Unnamed"]


passes2 = [btoa("CHAT"),btoa("Tudor"),btoa("AJB"),btoa("Coker"),"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]
let new150 = {
passwords: [passes2],
names: [names]
}
url = "https://retoolapi.dev/09OX6R/messages/150"
api("put",new150)  //*/


setInterval(e=>{
let button = document.querySelector("#sendBtn")
if (document.querySelector("input").value == "") {
  button.style.background = "#262529";
  button.querySelector("img").style.filter = "invert(100%) brightness(50%)"
  button.style.cursor = "not-allowed"
} else {
  button.style.background = "#1584ff";
  button.querySelector("img").style.filter = "invert(100%) brightness(100%)";
  button.style.cursor = "pointer"
}
},20)


api()
setInterval(api,1000)
setTimeout(e=>{setInterval(updateTexts,1000)},1000)
setInterval(updatePasses,1000);</script><style>input#type {
position: fixed;
bottom: 20px;
height: 40px;
left: 140px;
width: calc(100% - 205px);
border-radius: 12px;
background: #262529;
border: 1px solid #7c7c7c;
color: white;
padding-left: 8px;
}
.editBtn {
  position: absolute;
  top: -30px;
  left: 8.3px;
  background: #262529;
  color: white;
  border: 1px solid #7c7c7c;
  border-radius: 7px;
  height: auto;
  font-size: 16px;
  padding: 5px 5px 5px 5px;
  cursor: pointer;
}
.editBtn:hover {
  background: #323538;
}
h1 {
  background: #181818;
  padding: 6px 10px 6px 10px;
  border-radius: 10px;
  display: inline-block;
  height: 37px;
  border: 1px solid #282828;
  cursor: default;
}
button.reactBtn {
  width: 33px;
  height: 33px;
  text-align: center;
  background: #262529;
  border-radius: 9px;
  border: 1px solid #7c7c7c;
  cursor: pointer;
  padding: 0px 4px 0px 4px;
  z-index: 10000001;
  margin-right: 4px;
}
button.reactBtn:hover {
  background: #363539;
}
.reactSelected {
  background: #1584ff !important;
}
button#nameBtn {
position: fixed;
top: 10px;
right: 10px;
color: white;
background: black;
border: 1px solid white;
border-radius: 6px;
}
button#nameBtn:hover {
  background: #282828;
  cursor: pointer;
}
button.chatbtn {
display: inline-block;
width: 75px;
height: auto;
color: white;
background: black;
cursor: pointer;
font-size: 12px;
border: 1px solid #282828;
border-radius: 6px;
padding: 3px 0px 3px 0px;
margin: 0px 0px 4px 0px;
white-space: normal;
word-wrap: break-word;
overflow-wrap: break-word;
}
button.chatbtn:hover {
background: #222;
}
div#chats {
position: fixed;
left: 0px;
top: 0px;
border-top: none;
border-left: none;
border-bottom: none;
border-right: 5px solid gray;
border-radius: 0px;
width: 100px;
height: 100%;
overflow-y: scroll;
}
button#sendBtn {
position: fixed; /* Changed from absolute to fixed */
bottom: 20px;
height: 40px;
right: 10px;
width: 40px;
border: 1px solid #7c7c7c;
border-radius: 121px;
background: #262529;
color: #666;
transition: .2s;
cursor: default;
font-size: 17px;
padding-top: 5px;
}
span.myReact {
  background: #1584ff;
  border-radius: 5px;
  display: inline-block;
  height: 21px;
}
.nameplated {
position: relative;
padding-top: 15px;
}
.nameplated::after {
position: absolute; 
z-index: 100;
left: 5px;
top: -15px; 
background-color: #333;
color: white;
padding: 1px 5px;
border-radius: 4px;
font-size: 10px;
white-space: nowrap;
}
body {
background: black;
color: white
}
* {
font-family: Arial;
}
div {
padding: 8px;
border-radius: 10px;
--nameplateText: "";
}</style>