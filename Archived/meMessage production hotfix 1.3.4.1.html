<title>meMessage</title>
<link rel="icon" href="data:image/png;base64,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">
<center>
    <h1 id="title">
      Loading...
    </h1>
  </center>
  <div id="messages"></div>
  <div id="chats">
    
  </div>
  <input id="type" type="text" placeholder="new meMessage..." maxlength="200"/>
  <button id="sendBtn" onclick="send()"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACIAAAAiCAMAAAANmfvwAAAAclBMVEUAAAAVFRUVFRUBAQEAAAELCwsAAAEBAQIAAAAAAAABAQEBAgMAAAABAQEBAQEBAQIBAQEAAAAAAAAAAAEAAAAAAAEEBQUFBQgAAAABAQEBAQEAAQEBAQEBAQIDAwQCAgICAgIAAAACAgIEBAgAAAAAAACDMbP7AAAAJXRSTlMACQfe1gzmnGkEqKB68s/Kw7WwlYR2Ri8V+/j39c/Aim9oZj4S4HOyaQAAALlJREFUOMvdz8cWwiAUhOEhxZhmiWn2Ou//iiqHA0KElSu/1Sz+Q27gGu4Ie5xIjgiIZnwT8Eso1fBaUJkFinATJfywE5gQMW0pXDFdcBypeO9Z8YvELcLNkh6xCvKYXtvc/ItP7XylonK27rlQa0ElbamtYXYGk2BDzSQNTBIBhUmu+j07QaN2gTxTw01QyrlPAVHKO6aJvOcwytlVN9iJgNRXXQ7DSbQ/SdKfvAK/jFKJgGH+0sPyBNKAR2rwJ+2SAAAAAElFTkSuQmCC" width="17px" height="17px" style="filter: invert(100%) brightness(50%)"></button>
  <button id="nameBtn" onclick="changeName()">Change Chat Name</button><script>var url = `https://retoolapi.dev/09OX6R/messages/5`;
var max=0;
if (!localStorage.meMsgUser || localStorage.meMsgUser=="null") {
  localStorage.meMsgUser=prompt("Enter your first name...  (This is your display username, you cannot change it once it is set!)");
window.location.reload();
}
var username = localStorage.meMsgUser;
var passes;

var chatDiv = document.querySelector("#chats")
setTimeout(e=>{for (var i = 1;i <= 149;i++) {
let enterChatBtn = document.createElement("button");
enterChatBtn.setAttribute("number",i)
enterChatBtn.onclick=e=>{
  promptEntering(e.target.getAttribute("number"))
}
enterChatBtn.classList.add("chatbtn");
enterChatBtn.innerText = passes.names.toString().split(",")[i-1];

chatDiv.appendChild(enterChatBtn);
}},1300)


var msg = { messages: {} }
var O = {}
async function api(changeType="get", change={}) {
if (changeType == "put") {
  await fetch(url, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(change)
    })
  .then(response => response.json())
  .then(data => o = data)
} else if (changeType == "get") {
  await fetch(url,{method:"GET"}).then(r=>r.json()).then(d=>o=d)
  O=o

}
if (changeType == "add") {
  O = addMessage(change)
  api("put",O)
  window.scrollTo({ 
  top: document.body.scrollHeight, 
  behavior: "smooth" 
  })
}
msg = o
}

async function updatePasses() {
await fetch("https://retoolapi.dev/09OX6R/messages/150",{method:"GET"}).then(r=>r.json()).then(d=>passes=d)
passes=passes
}


function promptEntering(num) {
if (localStorage["enteredChat"+num]!=="yes") {
let pasio = passes.passwords.toString().split(",")[num-1];
let pass;
if (!pasio=="") {pass = btoa(prompt("Enter password..."));} else {pass=""}
if (pasio==pass) {
  url="https://retoolapi.dev/09OX6R/messages/"+num;
  localStorage["enteredChat"+num]="yes"
}
console.log(passes[num-1], num-1)
console.log(pass)
} else {
  url="https://retoolapi.dev/09OX6R/messages/"+num;
}
}

function addMessage(newMessage, targetObject = msg) {
    if (typeof targetObject !== 'object' || targetObject === null || !targetObject.messages) {
        console.error("Target object for adding message is invalid, returning default structure.");
        targetObject = { messages: {} };
    }
    
    const messages = targetObject.messages;
    const existingKeys = Object.keys(messages); 
    
    let maxIndex = 0;
    for (const key of existingKeys) {
        const index = parseInt(key.substring(1));
        if (index > maxIndex) {
            maxIndex = index;
        }
    }
    const newKey = `m${maxIndex + 1}`;
    
    const currentMessages = typeof targetObject.messages === 'object' && targetObject.messages !== null 
        ? targetObject.messages 
        : {};

    const newMessages = { 
        ...currentMessages, 
        [newKey]: newMessage  
    };
    
    return {  
        ...targetObject,  
        messages: newMessages  
    };
}

const updatedMessages = {
messages: {
  m1: {
    sender: {
      user: "Server",
      time: "0:00 AM"
    },
    message: "Chat reset by server admin"
  }
}
};

async function reset() {
  let resetStr = "Chat reset "
  let resetStrings = [
    "by Google Gemini", "by ChatGPT", "because the devs broke smth", "because geese broke into your house", "becuase the APs found you", "because your computer got isolated for going on furry dating websites", "by the Hollow Knight", "by Hornet", "by Jeffrey Epstein", "because Nintendo's suing us twin ü•Ä", "by a flock of ferocious furry femboys", "because a wild NullReferenceException appeared", "because your CPU ran out of elixir", "because nobody would join Jarred in Kart Bros", "by \"Uncaught TypeError: Cannot read properties of undefined (reading 'reset')\"", "by sneaky golem in the pocket", "by Clippy", "by evo skelly nike pro", "bc ur chopped twin ü•Äüò≠üò≠üôè"
  ]
  resetStr += resetStrings[Math.floor(Math.random()*resetStrings.length)]
  updatedMessages.messages.m1.message=resetStr;
  await api("put",updatedMessages)
}

async function resetAll() {
  for (var i = 123;i < 150;i++) {
    url = "https://retoolapi.dev/09OX6R/messages/"+i
    await reset()
  }
}

function getTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0'); 
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12; 
    return `${displayHours}:${minutes} ${ampm}`;
}

function send() {
if (document.querySelector("input").value=="") {} else {
  // FIXED: Sender and Message are now strings, not single-element arrays
  api("add",{sender: {user: username, time: getTime()}, message: document.querySelector("input").value});
  document.querySelector("input").value=""
  let button = document.querySelector("#sendBtn")
  button.style.background = "#262529";
  button.querySelector("img").style.filter = "invert(100%) brightness(50%)"
  button.style.cursor = "not-allowed"
  setTimeout(() => { window.scrollTo({
      top: document.body.scrollHeight,
      behavior: "smooth"
  });
}, 1100)
}
}

document.onkeypress=e=>{if (e.key=="Enter") {send()}}
var m;
fetch("https://retoolapi.dev/09OX6R/messages/1",{method:"GET"}).then(r=>r.json()).then(d=>m=d.messages)

fetch(url).then(r=>r.json()).then(d=>max=Object.keys(d.messages).length);


async function changeName() {
let num = Number(url.split("messages/")[1]);
let newName = prompt("Enter new chat name...  (Max length 16 characters, click cancel or press escape to return)");
if (newName==null||newName=="") {} else {
  newName = newName.substring(0,16)
  console.log(newName)

let newPasses = passes.names.toString().split(",");
newPasses[num-1]=newName
console.log(newPasses)
let new150 = {
  names: [newPasses],
  passwords: [passes.passwords]
}
console.log(new150)
let preUrl=url;
url="https://retoolapi.dev/09OX6R/messages/150";
await api("put",new150);
url=preUrl;
location.reload()
}
}


function edit(messageIndex, editType, editData) {
  let messageToEdit = msg.messages["m"+messageIndex];
  if (editType == "all") {
    messageToEdit = editData;
  }
  if (editType == "message") {
    messageToEdit.message = editData;
  }
  if (editType == "time") {
    messageToEdit.sender.time = editData;
  }
  if (editType == "user") {
    messageToEdit.sender.user = editData;
  }
  if (editType == "reactions") {
    messageToEdit.reactions = editData;
  }
  msg.messages["m"+messageIndex] = messageToEdit;
  api("put",msg);
}


function updateTexts() {
    if (!msg || !msg.messages) {
        return;
    }
    let scrollWhy = window.scrollY;
    
let chatNum = parseInt(url.split("messages/")[1]);
let chatDiv = document.getElementById("chats");
document.querySelector("h1").innerText = chatDiv.querySelectorAll("button")[chatNum-1].innerText;

document.querySelector("#messages").innerHTML="";
for (var i = 0; i < Object.keys(msg.messages).length; i++) {
  let bubble = document.createElement("div");
  bubble.____MID=i+1
  let sender = msg.messages["m"+(i+1)]
  bubble.style = `
    position: absolute;
    top: ${70*i+100}px;
    ${sender.sender.user==username?("right: 50px;"):"left: 130px;"}
    background: ${sender.sender.user==username?("#1584ff"):"#262529"};
    color: white;
    min-height: 40px; 
    border: 1px solid black;
    display: inline-block;
    min-width: 35px;
    max-width: 75%;
    overflow-wrap: break-word;
    cursor: default;
  `
  bubble.oncontextmenu = _thisBubble => {
    try{
      sender = msg.messages["m"+_thisBubble.target.____MID].sender;}
    catch{
      return;}
    _thisBubble.preventDefault();
    var reactUi = document.createElement("div");
    reactUi.style = `
      position: fixed;
      bottom: 20px;
      height: 40px;
      left: 140px;
      width: calc(100% - 225px);
      border-radius: 12px;
      background: #262529;
      border: 1px solid #7c7c7c;
      color: white;
      z-index: 10001;
      padding-left: 8px;
    `
    document.body.appendChild(reactUi);
    let blackness = document.createElement("div");
    blackness.addEventListener("click", () => {
      document.body.removeChild(reactUi)
    });
    blackness.style=`
    position: absolute;
    left: -10000px;
    top: -10000px;
    width: 30000px;
    height: 30000px;
    background: #0008;
    z-index: -100;
    `
    reactUi.appendChild(blackness)

    if (msg.messages["m"+_thisBubble.target.____MID].sender.user==username) {
      let editBtn = document.createElement("button");
      editBtn.onclick = e => {
        let currentMsg = msg.messages["m"+_thisBubble.target.____MID].message;
        let editValue = Array.isArray(currentMsg) ? currentMsg[0] : currentMsg;
        let newMsg = prompt("Enter edited message", editValue)
        if (newMsg == null || newMsg.trim() == "") {} else {
          edit(_thisBubble.target.____MID,"message",newMsg);
          document.body.removeChild(reactUi);
        }
      }
      editBtn.classList.add("editBtn")
      editBtn.innerText = "Edit Message";
      reactUi.appendChild(editBtn)
    }

    let defaultReactions = ["‚ù§Ô∏è", "üòÇ", "üëç", "üëé", "‚ùï", "‚ùî","üêê","üòÆ","üò°","üòù","ü§ë","ü§î","üò≠","ü•Ä","üíÄ","‚òπÔ∏è","üî•","üéâ","üôè","üñï","ü´¶","ü•∑","üëØ‚Äç‚ôÄÔ∏è","ü§π‚Äç‚ôÇÔ∏è","üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®","ü¶≤","üçÜ","üçí","üßä","üïã","üåà","‚ö°","‚õÑ","üß¢","üìé"];
    const currentUsername = username;
    const targetMessageId = "m" + _thisBubble.target.____MID;
    const targetMessageObject = msg.messages[targetMessageId];
    const userExistingReaction = targetMessageObject.reactions ? targetMessageObject.reactions[currentUsername] : undefined;

    for (const emoji of defaultReactions) {
        let btn = document.createElement("button");
        btn.innerText = emoji;
        btn.classList.add("reactBtn");
        if (userExistingReaction === emoji) { btn.classList.add("reactSelected"); }
        btn.onclick = (_thisButton) => {
            const messageObject = targetMessageObject; 
            if (!messageObject.reactions) { messageObject.reactions = {}; }
            if (messageObject.reactions[currentUsername] === emoji) {
                delete messageObject.reactions[currentUsername];
            } else {
                messageObject.reactions[currentUsername] = emoji; 
            }
            edit(_thisBubble.target.____MID, "reactions", messageObject.reactions);
            document.body.removeChild(reactUi);
        };
        reactUi.appendChild(btn);
        document.onkeydown=e=>e.key=="Escape"?document.body.removeChild(reactUi):0;
    }
  }

  // FIXED: Check if sender.message is an array or string before replacing
  let messageText = Array.isArray(sender.message) ? sender.message[0] : sender.message; 
  const urlRegex = /(\b(https?:\/\/[^\s]+|www\.[^\s]+)(\b|$))/g;
  let linkedMessageText = messageText.replace(urlRegex, (match) => {
      let url = match;
      if (url.startsWith('www.')) { url = 'http://' + url; }
      return `<a href="${url}" target="_blank" style="color: white; text-decoration: underline;">${match}</a>`;
  });

  bubble.innerHTML = linkedMessageText;
  document.querySelector("#messages").appendChild(bubble)

  // FIXED: Simplified username comparison
  if (sender.sender.user != username) {
    var nameplate = document.createElement("span");
    nameplate.innerText = sender.sender.user + ", " + sender.sender.time;
    nameplate.style = `
      position: absolute;
      font-size: 9px;
      top: -10px;
      left: 5px;
      white-space: nowrap;
      z-index: 9000000000000000;
    `
    bubble.appendChild(nameplate);
  }

  if (!!sender.reactions && Object.keys(sender.reactions).length > 0) {
      let reactionsHTML = "";
      for (var j in msg.messages["m"+(i+1)].reactions) {
        if (j==username) reactionsHTML+=" <span class='myReact'>"+msg.messages["m"+(i+1)].reactions[j]+"</span>"
        else reactionsHTML+=" "+msg.messages["m"+(i+1)].reactions[j]
      }
      var reaction = document.createElement("span");
      reaction.innerHTML = reactionsHTML; 
      reaction.style = `
      position: absolute;
      ${sender.sender.user==username?("right"):"left"}: ${bubble.offsetWidth-7.5}px; 
      white-space: nowrap;
      top: -10px;
      background: #262529;
      border-radius: 9px;
      border: 1px solid white;
      padding: 1px 4px;
      `;
      bubble.appendChild(reaction);
  }
}

let b = document.createElement("div");
b.style = `
    position: absolute;
    top: ${70*(Object.keys(msg.messages).length)+100}px;
    width: 70%;
    height: 40px;
    border: none;
  `
document.querySelector("#messages").appendChild(b)
window.scrollTo({top: scrollWhy})
}

setInterval(e=>{
let button = document.querySelector("#sendBtn")
if (document.querySelector("input").value == "") {
  button.style.background = "#262529";
  button.querySelector("img").style.filter = "invert(100%) brightness(50%)"
  button.style.cursor = "not-allowed"
} else {
  button.style.background = "#1584ff";
  button.querySelector("img").style.filter = "invert(100%) brightness(100%)";
  button.style.cursor = "pointer"
}
},20)

api()
setInterval(api,1000)
setTimeout(e=>{setInterval(updateTexts,1000)},1000)
setInterval(updatePasses,1000);</script><style>input#type {
position: fixed;
bottom: 20px;
height: 40px;
left: 140px;
width: calc(100% - 205px);
border-radius: 12px;
background: #262529;
border: 1px solid #7c7c7c;
color: white;
padding-left: 8px;
}
.editBtn {
  position: absolute;
  top: -30px;
  left: 8.3px;
  background: #262529;
  color: white;
  border: 1px solid #7c7c7c;
  border-radius: 7px;
  height: auto;
  font-size: 16px;
  padding: 5px 5px 5px 5px;
  cursor: pointer;
}
.editBtn:hover {
  background: #323538;
}
h1 {
  background: #181818;
  padding: 6px 10px 6px 10px;
  border-radius: 10px;
  display: inline-block;
  height: 37px;
  border: 1px solid #282828;
  cursor: default;
}
button.reactBtn {
  width: 33px;
  height: 33px;
  text-align: center;
  background: #262529;
  border-radius: 9px;
  border: 1px solid #7c7c7c;
  cursor: pointer;
  padding: 0px 4px 0px 4px;
  z-index: 10000001;
  margin-right: 4px;
}
button.reactBtn:hover {
  background: #363539;
}
.reactSelected {
  background: #1584ff !important;
}
button#nameBtn {
position: fixed;
top: 10px;
right: 10px;
color: white;
background: black;
border: 1px solid white;
border-radius: 6px;
}
button#nameBtn:hover {
  background: #282828;
  cursor: pointer;
}
button.chatbtn {
display: inline-block;
width: 75px;
height: auto;
color: white;
background: black;
cursor: pointer;
font-size: 12px;
border: 1px solid #282828;
border-radius: 6px;
padding: 3px 0px 3px 0px;
margin: 0px 0px 4px 0px;
white-space: normal;
word-wrap: break-word;
overflow-wrap: break-word;
}
button.chatbtn:hover {
background: #222;
}
div#chats {
position: fixed;
left: 0px;
top: 0px;
border-top: none;
border-left: none;
border-bottom: none;
border-right: 5px solid gray;
border-radius: 0px;
width: 100px;
height: 100%;
overflow-y: scroll;
}
button#sendBtn {
position: fixed; 
bottom: 20px;
height: 40px;
right: 10px;
width: 40px;
border: 1px solid #7c7c7c;
border-radius: 121px;
background: #262529;
color: #666;
transition: .2s;
cursor: default;
font-size: 17px;
padding-top: 5px;
}
span.myReact {
  background: #1584ff;
  border-radius: 5px;
  display: inline-block;
  height: 21px;
}
.nameplated {
position: relative;
padding-top: 15px;
}
.nameplated::after {
position: absolute; 
z-index: 100;
left: 5px;
top: -15px; 
background-color: #333;
color: white;
padding: 1px 5px;
border-radius: 4px;
font-size: 10px;
white-space: nowrap;
}
body {
background: black;
color: white
}
* {
font-family: Arial;
}
div {
padding: 8px;
border-radius: 10px;
--nameplateText: "";
}</style>