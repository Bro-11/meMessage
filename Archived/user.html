<html>
  <head>
  </head>
  <body>
    <center>
      <h1>
        meMessage
      </h1>
    </center>
    <div id="messages"></div>
    <input id="type" type="text" />
    <button onclick="send()">Send</button>
    <script>
    var url = 'https://retoolapi.dev/09OX6R/messages/1';
var max=0;
var username = "User"


var msg = ""
var O = ""
async function api(changeType="get", change={}) {
  if (changeType == "put") {
    await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(change)
      })
    .then(response => response.json())
    .then(data => o = data)
  } else if (changeType == "get") {
    await fetch(url,{method:"GET"}).then(r=>r.json()).then(d=>o=d)
    O=o
    if (O == msg) {window.scrollTo(0, 1000000);

    }
  
  }
  if (changeType == "add") {
    O = addMessage(change)
    console.log(O)
    api("put",O)
  }
  msg = o
}


function addMessage(newMessage, targetObject=msg) {
  const messages = targetObject.messages;
  const existingKeys = Object.keys(messages);
  let maxIndex = 0;
  for (const key of existingKeys) {
    const index = parseInt(key.substring(1));
    if (index > maxIndex) {
      maxIndex = index;
    }
  }
  const newKey = `m${maxIndex + 1}`;
  const newMessages = { ...messages, 
    [newKey]: newMessage 
  };
  return { 
    ...targetObject, 
    messages: newMessages 
  };
}

const updatedMessages = {
  messages: {
    m1: {
      sender: "User",
      message: "hi"
    }
  }
};

     //       api("put",updatedMessages)

function send() {
  if (document.querySelector("input").value=="") {} else {
    api("add",{sender: [username],message: [document.querySelector("input").value]});
    document.querySelector("input").value=""
  }
}

document.onkeydown=e=>{if (e.key=="Enter") {send()}}
var m;
fetch("https://retoolapi.dev/09OX6R/messages/1",{method:"GET"}).then(r=>r.json()).then(d=>m=d.messages)

fetch(url).then(r=>r.json()).then(d=>max=Object.keys(d.messages).length);

function updateTexts() {
  document.querySelector("#messages").innerHTML="";
  for (var i = 0;i < Object.keys(msg.messages).length;i++) {
    let bubble = document.createElement("div");
    let sender = msg.messages["m"+(i+1)]
    bubble.style = `
      position: absolute;
      top: ${50*i+90}px;
      ${sender.sender==username?("right: 50px;"):"left: 20px;"}
      background: ${sender.sender==username?("#1584ff"):"#262529"};
      color: white;
      width: 70%;
      height: 40px;
      border: 1px solid black;
    `
    bubble.innerText = sender.message
    document.querySelector("#messages").appendChild(bubble)
  }
  let b = document.createElement("div");
b.style = `
      position: absolute;
      top: ${50*(Object.keys(msg.messages).length)+10}px;
      width: 70%;
      height: 40px;
      border: none;
    `
document.querySelector("#messages").appendChild(b)
}
api()
setInterval(api,1000)
setInterval(updateTexts,1000)
    </script>
    <style>
    input#type {
  position: fixed;
  bottom: 20px;
  height: 15px;
  left: 5px;
  width: calc(100% - 90px);
}
button {
  position: fixed; /* Changed from absolute to fixed */
  bottom: 20px;
  height: 20px;
  right: 10px;
  width: 60px;
}
body {
  background: black;
  color: white
}
* {
  font-family: Arial;
}
div {
  padding: 3px;
  border-radius: 10px;
}

    </style>
  </body>
</html>